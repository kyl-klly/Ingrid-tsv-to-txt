<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TSV to Crossword TXT</title>
</head>
<body>
  <h1>Upload the TSV file (from Ingrid)</h1>
  <input type="file" id="fileInput" accept=".tsv" />

  <script>
    function convertToCurly(text) {
      // First replace apostrophes inside words (like don't, you're)
      text = text.replace(/(\w)'(\w)/g, '$1’$2');

      // Replace opening and closing double quotes
      let isDoubleOpen = true;
      text = text.replace(/"/g, () => (isDoubleOpen = !isDoubleOpen) ? '“' : '”');

      // Replace opening and closing single quotes
      let isSingleOpen = true;
      text = text.replace(/'/g, () => (isSingleOpen = !isSingleOpen) ? '‘' : '’');

      return text;
    }

    function padToMaxLength(clues, maxLength) {
      const tabSize = 7;
      return clues.map(clue => {
        const neededTabs = Math.floor((maxLength - clue.length) / tabSize);
        return clue + '\t'.repeat(neededTabs);
      });
    }

    document.getElementById('fileInput').addEventListener('change', (event) => {
      const file = event.target.files[0];
      const reader = new FileReader();

      reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.trim().split('\n');
        const originalRows = lines.slice(1).map(line => line.split('\t'));

        // First pass: collect all clues with smart quotes
        const clues = originalRows.map(row => {
          if (row.length >= 4) row.splice(3, 1); // remove notes
          return convertToCurly(row[2] || '');
        });

        const maxLength = Math.max(...clues.map(c => c.length));
        const paddedClues = padToMaxLength(clues, maxLength);

        let output = '';
        let clueIndex = 0;
        let acrossWritten = false;
        let downWritten = false;

        // First block: Number, padded clue, answer
        for (const row of originalRows) {
          if (row.length >= 4) row.splice(3, 1);
          const clue = paddedClues[clueIndex];
          const answer = (row[1] || '').toUpperCase();
          const number = row[0].replace(/\D/g, '');
          const label = row[0];

          if (label.includes('A') && !acrossWritten) {
            output += 'Across\n';
            acrossWritten = true;
          }
          if (label.includes('D') && !downWritten) {
            output += '\nDown\n';
            downWritten = true;
          }

          output += `${number}\t${clue}\t${answer}\n`;
          clueIndex++;
        }

        output += '\n\n';

        // Second block: Number + unpadded clue
        acrossWritten = false;
        downWritten = false;
        for (const row of originalRows) {
          if (row.length >= 4) row.splice(3, 1);
          const clue = convertToCurly(row[2] || '').replace(/\t+$/, '');
          const number = row[0].replace(/\D/g, '');
          const label = row[0];

          if (label.includes('A') && !acrossWritten) {
            output += 'Across\n';
            acrossWritten = true;
          }
          if (label.includes('D') && !downWritten) {
            output += '\nDown\n';
            downWritten = true;
          }

          output += `${number}\t${clue}\n`;
        }

        // Download result
        const blob = new Blob([output], { type: 'text/plain' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'FORMATTED_' + file.name.replace('.tsv', '.txt');
        link.click();
      };

      reader.readAsText(file);
    });
  </script>
</body>
</html>
