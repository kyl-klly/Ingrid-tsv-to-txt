<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TSV to Crossword TXT</title>
</head>
<body>
  <h1>Upload TSV file (from Ingrid)</h1>
  <input type="file" id="fileInput" accept=".tsv" />

  <script>
    // Mimics Python's csv.reader quote handling
    function parseTSV(tsvText) {
      return tsvText.trim().split('\n').map(line => {
        const regex = /"(.*?)"|([^\t]+)/g;
        const fields = [];
        let match;
        while ((match = regex.exec(line)) !== null) {
          let field = match[1] !== undefined ? match[1] : match[2];
          // Unescape double quotes
          field = field.replace(/""/g, '"');
          fields.push(field);
        }
        return fields;
      });
    }

    function convertToCurly(text) {
      // Handle apostrophes like don't
      text = text.replace(/(\w)'(\w)/g, '$1’$2');
      // Handle double quotes as pairs
      let isDoubleOpen = true;
      text = text.replace(/"/g, () => (isDoubleOpen = !isDoubleOpen) ? '“' : '”');
      // Handle single quotes as pairs
      let isSingleOpen = true;
      text = text.replace(/'/g, () => (isSingleOpen = !isSingleOpen) ? '‘' : '’');
      return text;
    }

    function padToMaxLength(clues, maxLength) {
      const tabSize = 7;
      return clues.map(clue => {
        const neededTabs = Math.floor((maxLength - clue.length) / tabSize);
        return clue + '\t'.repeat(neededTabs);
      });
    }

    document.getElementById('fileInput').addEventListener('change', (event) => {
      const file = event.target.files[0];
      const reader = new FileReader();

      reader.onload = function(e) {
        const lines = e.target.result;
        const allRows = parseTSV(lines);
        const rows = allRows.slice(1); // Skip header

        const clues = rows.map(row => convertToCurly(row[2] || ''));
        const maxLength = Math.max(...clues.map(c => c.length));
        const paddedClues = padToMaxLength(clues, maxLength);

        let output = '';
        let clueIndex = 0;
        let acrossWritten = false;
        let downWritten = false;

        // Section 1: Number + padded clue + uppercase answer
        for (const row of rows) {
          if (row.length >= 4) row.splice(3, 1);
          const clue = paddedClues[clueIndex];
          const answer = (row[1] || '').toUpperCase();
          const number = row[0].replace(/\D/g, '');
          const label = row[0];

          if (label.includes('A') && !acrossWritten) {
            output += 'Across\n';
            acrossWritten = true;
          }
          if (label.includes('D') && !downWritten) {
            output += '\nDown\n';
            downWritten = true;
          }

          output += `${number}\t${clue}\t${answer}\n`;
          clueIndex++;
        }

        output += '\n\n';

        // Section 2: Number + clue only (fresh re-parse for clean clues)
        acrossWritten = false;
        downWritten = false;
        clueIndex = 0;

        for (const row of rows) {
          if (row.length >= 4) row.splice(3, 1);
          const clue = convertToCurly(row[2] || '').replace(/\t+$/, '');
          const number = row[0].replace(/\D/g, '');
          const label = row[0];

          if (label.includes('A') && !acrossWritten) {
            output += 'Across\n';
            acrossWritten = true;
          }
          if (label.includes('D') && !downWritten) {
            output += '\nDown\n';
            downWritten = true;
          }

          output += `${number}\t${clue}\n`;
          clueIndex++;
        }

        const blob = new Blob([output], { type: 'text/plain' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = '(formatted)_' + file.name.replace('.tsv', '.txt');
        link.click();
      };

      reader.readAsText(file);
    });
  </script>
</body>
</html>
